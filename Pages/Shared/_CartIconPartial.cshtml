@* Pages/Shared/_CartIconPartial.cshtml *@
@inject E_commerce.Services.Interfaces.ICartService CartService
@using E_commerce.Helpers

@{
    try
    {
        var userId = User.Identity?.IsAuthenticated == true
            ? User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value
            : null;

        int itemCount;

        if (userId == null)
        {
            // Pour les visiteurs : utiliser le cookie
            var cart = CookieHelper.GetOrCreateCart(Context);
            itemCount = cart.Items?.Sum(i => i.Quantity) ?? 0;
        }
        else
        {
            // Pour les utilisateurs connectés : utiliser le service
            var cartId = CookieHelper.GetOrCreateCartId(Context);
            itemCount = await CartService.GetCartItemCountAsync(userId, cartId);
        }

        <a asp-page="/Cart/Index" class="nav-link position-relative">
            <i class="fas fa-shopping-cart fa-lg"></i>
            @if (itemCount > 0)
            {
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    @itemCount
                    <span class="visually-hidden">articles dans le panier</span>
                </span>
            }
        </a>
    }
    catch (Exception ex)
    {
        // En cas d'erreur, afficher juste l'icône sans badge
        <a asp-page="/Cart/Index" class="nav-link position-relative">
            <i class="fas fa-shopping-cart fa-lg"></i>
        </a>
    }
}